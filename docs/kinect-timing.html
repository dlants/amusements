<!DOCTYPE html>
<html>
<head>
  <title>kinect timing issues</title>
  <style>button,hr,input{overflow:visible}audio,canvas,progress,video{display:inline-block}progress,sub,sup{vertical-align:baseline}html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0} menu,article,aside,details,footer,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:100%;line-height:1.15;margin:0}button,input{}button,select{text-transform:none}[type=submit], [type=reset],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}[hidden],template{display:none}.tableOfContents_f1uwvcyt{padding-bottom:10px;padding-top:10px}.tableOfContents_f1uwvcyt ul{list-style:none;margin:0;padding-left:0}.tableOfContents_f1uwvcyt li{padding-bottom:4px;padding-top:4px}.tableOfContents_f1uwvcyt a{color:hsl(0, 0%, 0%);text-decoration:none}.tableOfContents_f1uwvcyt a:hover{text-decoration:underline}.heading_f12eg0h7 a{color:inherit;text-decoration:none}.heading_f12eg0h7 a:hover{text-decoration:underline}.code_f1w1fzvs{background-color:hsl(0, 0%, 90%);border-radius:3px;font-family:'Roboto Mono', monospace;font-size:0.9em;padding:2px}.codeBlock_fuc7d7h{background-color:hsl(0, 0%, 90%);border-radius:4px;font-family:'Roboto Mono', monospace;font-size:0.85em;overflow-x:auto;padding:12px;white-space:pre-wrap;word-break:break-word}.blockquote_ffkcpe7{border-left:3px solid hsl(0, 0%, 60%);color:hsl(0, 0%, 60%);margin-left:0;padding-left:16px}.table_f1nyxqnd{border-collapse:collapse;margin-bottom:16px;margin-top:16px;width:100%}.tableCell_f1yllkyw{border:1px solid hsl(0, 0%, 90%);padding:8px}.image_f6w00t0{max-width:100%}.embedContainer_fa48ejj{height:0;margin-bottom:16px;margin-top:16px;padding-bottom:56.25%;position:relative;width:100%}.embedContainer_fa48ejj iframe{height:100%;left:0;position:absolute;top:0;width:100%}.captionedImage_f1x6g9qq{align-items:center;display:flex;flex-direction:column;margin-bottom:16px;margin-top:16px}.caption_fqua3ls{color:hsl(0, 0%, 60%);font-size:0.9em;font-style:italic;margin-top:8px;max-width:90%;padding-left:16px;text-align:left}.header_f15ej8wx{-ms-flex-direction:column;-ms-flex-negative:0;-webkit-flex-direction:column;-webkit-flex-shrink:0;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:column;flex-shrink:0}.topHeaderRow_fmhimpa{background:hsl(0, 0%, 90%)}.headerRow_f1jl748l{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:flex-end;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0;flex-wrap:nowrap;max-width:100%;overflow:hidden;padding-left:15px;padding-right:15px}.headerRow_f1jl748l>*{margin-right:10px !important}.headerRow_f1jl748l>*:last-child{margin-right:0px !important}.headerItem_fu8qgk4{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0}.headerItem_fu8qgk4 a{color:hsl(0, 0%, 0%);text-decoration:none;text-decoration-color:hsl(0, 0%, 90%)}.headerItem_fu8qgk4 a:hover{background-color:hsl(0, 0%, 90%)}.homeLink_f1xjhvru{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:center;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0;text-decoration:none}.homeLink_f1xjhvru>*{margin-right:10px !important}.homeLink_f1xjhvru>*:last-child{margin-right:0px !important}.homeLink_f1xjhvru img{max-height:30px}.divider_fiw0lep,.contentPadding_fiw0lep,.postTitle_fiw0lep{-ms-flex:1;-webkit-flex:1;flex:1}.rightSection_fqrlanr{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:center;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0}.rightSection_fqrlanr>*{margin-right:10px !important}.rightSection_fqrlanr>*:last-child{margin-right:0px !important}.page_fghohlb{-ms-flex-direction:column;-webkit-flex-direction:column;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-direction:column}.contentContainer_f16f73v0{-ms-flex:1;-ms-flex-direction:row;-webkit-flex:1;-webkit-flex-direction:row;display:-ms-flexbox;display:-webkit-flex;display:flex;flex:1;flex-direction:row}.content_f14hn0h0{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0}@media (min-width: 741px){.content_f14hn0h0{max-width:720px}}@media (max-width: 740px){.content_f14hn0h0{padding-left:10px;padding-right:10px;width:100%}}.footer_fg9dplh{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0;height:300px}html{font-size:16px;line-height:1.5}html a{color:hsl(0, 0%, 40%);text-decoration-color:hsl(0, 0%, 40%)}html ol,html ol ol ol ol{list-style-type:decimal}html ol ol,html ol ol ol ol ol{list-style-type:lower-alpha}html ol ol ol,html ol ol ol ol ol ol{list-style-type:lower-roman}html, body{height:100%;margin:0;padding:0;width:100%}html{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}#root{height:100%;width:100%}.postList_f1vpqs3t{-ms-flex-direction:column;-webkit-flex-direction:column;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-direction:column}.postList_f1vpqs3t>*{margin-bottom:10px !important}.postList_f1vpqs3t>*:last-child{margin-bottom:0px !important}.postRow_fay7vi3{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0}.postRow_fay7vi3>*{margin-right:10px !important}.postRow_fay7vi3>*:last-child{margin-right:0px !important}.postDate_f1hnfeg5{-ms-flex-negative:0;-webkit-flex-shrink:0;color:hsl(0, 0%, 60%);flex-basis:auto;flex-shrink:0;min-width:100px}.postTitle_fxdkkk0{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0}.tag_fmp4oti{-ms-flex-negative:0;-webkit-flex-shrink:0;background-color:hsl(0, 0%, 90%);border-radius:3px;flex-basis:auto;flex-shrink:0;font-size:0.85em;padding:2px 6px}.pageTitle_f4350h6{font-size:2em;margin-bottom:10px}.subtitle_f1smo6w8{margin-bottom:30px}.section_f1lnkzdl{-ms-flex-direction:column;-webkit-flex-direction:column;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-direction:column;margin-bottom:30px}.sectionTitle_fnb89nq{font-size:1.5em;margin-bottom:5px}.legend_fattp86{color:hsl(0, 0%, 60%);font-size:0.9em;margin-bottom:15px}.postRow_f1fes45i{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:flex-start;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0}.postRow_f1fes45i>*{margin-right:10px !important}.postRow_f1fes45i>*:last-child{margin-right:0px !important}.starIndicator_fdfkslr{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0;text-align:center;width:16px}.postDate_f6dpeik{-ms-flex-negative:0;-webkit-flex-shrink:0;color:hsl(0, 0%, 60%);flex-basis:auto;flex-shrink:0}.pageTitle_faq0mi2{font-size:1.4em;font-weight:bold;margin-bottom:20px}</style>
  <style>
    html { font-family: 'Roboto', sans-serif; }
  </style>
  <link rel="icon" href="./black-rectangle.svg">
  <meta name="viewport" content="width=device-width">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono" rel="stylesheet">
  <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
</head>
<body>
  <a rel="me" style="display: none" href="https://mastodon.dlants.me/@dlants">Mastodon</a>
  <div id="root">
    <div class="page_fghohlb"><div class="header_f15ej8wx"><div class="headerRow_f1jl748l topHeaderRow_fmhimpa"><a class="homeLink_f1xjhvru" href="index.html"><div><?xml version="1.0" encoding="utf-8"?>
<svg width="9px" height="16px" viewBox="0 0 9 16" id="emoji" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="9" height="16" fill="rgb(0, 0, 0)"/>
</svg>
</div><span>dlants.me</span></a><div class="divider_fiw0lep"></div><div class="rightSection_fqrlanr"><div class="headerItem_fu8qgk4"><a href="tech.html">tech</a></div><div class="headerItem_fu8qgk4"><a href="climbing.html">climbing</a></div><div class="headerItem_fu8qgk4"><a href="education.html">education</a></div><div class="headerItem_fu8qgk4"><a href="etc.html">etc</a></div><div class="headerItem_fu8qgk4"><a href="about.html">about me + contact</a></div><div class="headerItem_fu8qgk4 subscribe_f45h">| <a href="rss">rss</a> <a href="atom">atom</a> <a href="buttondown.html">newsletter</a></div></div></div></div><div class="contentContainer_f16f73v0"><div class="contentPadding_fiw0lep"></div><div class="content_f14hn0h0"><h1>kinect timing issues</h1><div style="color:#666;font-size:0.9em;margin-bottom:1em">June 17, 2012</div><p>While dealing with data in multiple modalities (sound, accelerometry, video), or even just data collected by multiple sensors, one serious and often unexpected issue is synchronization. In my current project, I ran into a problem with synchronizing my kinect recordings. This lead me to investigate the issue of keeping consistent time in kinect. While using OpenNI and their supported recording format (.oni), I discovered that the kinect and the Asus XTION Pro sensor had some issues keeping up with their reported FPS settings. Not all hope is lost, however, since kinect recording automatically time stamps every frame, so with a bit of effort one can easily interpolate existing recordings and retrieve recordings with consistent FPS. In this post, I will explain everything in detail and provide code that you can use to record data with optimal fps, as well as interpolate kinect recordings and output lossless avi video of the rgb and depth channels.</p><p>So, what do I mean by consistent timing, and why is it an important issue to keep in mind? Well, consider a Kinect recording in a typical setup – running as one of many processes on a machine while providing visualization of every frame that it collects. Below is my code for doing this in OpenCV 2.3.1 and OpenNI 1.5.4.0:</p><pre class="codeBlock_fuc7d7h"><code>// Set everything up... see file record.cpp in attachment for full code.
#define VISUALIZE

//...
mapMode.nFPS = 30;
g_depth.SetMapOutputMode(mapMode);
g_image.SetMapOutputMode(mapMode);
//...

// Recording loop
while(cv::waitKey(1) != 1048603) { // Wait for esc key.
  // Get new data when available
  nRetVal = g_image.WaitAndUpdateData();
  if (nRetVal != XN_STATUS_OK) {
    printf(&quot;Failed updating: %s\n&quot;, xnGetStatusString(nRetVal));
    return false;
  }
  nRetVal = g_depth.WaitAndUpdateData();
  if (nRetVal != XN_STATUS_OK) {
    printf(&quot;Failed updating: %s\n&quot;, xnGetStatusString(nRetVal));
    return false;
  }
  recorder.Record();

#ifdef VISUALIZE
  // Visualize
  pDepthMap = g_depth.GetDepthMap();
  pImageMap = g_image.GetRGB24ImageMap();

  // My own functions, defined in record.cpp
  convert_pixel_map(pDepthMap, depth, mapMode.nYRes, mapMode.nXRes);
  convert_pixel_map(pImageMap, rgb, mapMode.nYRes, mapMode.nXRes);

  cv::imshow(&quot;rgb&quot;, rgb);
  cv::imshow(&quot;depth&quot;, depth);
#endif
}</code></pre><p>I analyzed the above recordings, and these are some figures I produced:</p><p><img class="image_f6w00t0" src="/images/kinect-timing/abc.png"/></p><p><img class="image_f6w00t0" src="/images/kinect-timing/abc-1.png"/></p><p><img class="image_f6w00t0" src="/images/kinect-timing/abc-2.png"/></p><p>The leftmost image is the number of frames dropped on the y axis, and the frame into the recording on the x axis. The second image shows a log of how the FPS of recording vary as the recording progresses. Finally, the last graph is a histogram of how the FPS was distributed in the recording. You can clearly see that on a busy machine with visualization, the Kinect gets nowhere close to the 30 FPS it’s supposed to record, and most of the time hovers around 27 FPS. This means that if you are trying to synchronize against this recording using the FPS, by 1 minute into the recording you’ll be about 6 seconds off. Also, if you are trying to analyze the accelerations or the amount of movement in the recording, about every 10th frame you may get faulty readings from the frame rate fluctuating up and down.</p><p>Even if you record on a dedicated machine, using an Asus XTION Pro sensor (which is capable of going up to 60 FPS), the above code with the VISUALIZATION flag removed produces the following figures:</p><p><img class="image_f6w00t0" src="/images/kinect-timing/framesdroppedkitchen.png"/></p><p><img class="image_f6w00t0" src="/images/kinect-timing/fpslogkitchen.png"/></p><p><img class="image_f6w00t0" src="/images/kinect-timing/fpskitchen.png"/></p><p>As you can see, the frame rate is much more consistent and stays at 30fps most of the time. Nonetheless, you still experience occasional slowness and as a consequence – drift. In this case, the drift is about 1% of frames, as opposed to the 10% in the code above.</p><p>As I mentioned before, there is hope. Thankfully, the people at OpenNI were kind enough to time stamp every frame the recorder collects down to the microsecond, and these time stamps are accessible in the OpenNI player. Using this information, I wrote a script to interpolate the recording with duplicates of the current frame, when the recording drifts by more than 1 frame of where it should be. Here are the important parts of that code (full code in attachment).</p><pre class="codeBlock_fuc7d7h"><code>// How to access timestamps.
xn::XnUInt32 frame;
xn::XnUInt64 timestamp;
xn::Player player;

// ...

player.TellFrame(depthname, frame);
player.TellTimestamp(timestamp);

// ...

// My code for interpolation.
// Increment frameswritten whenever you write a new frame to the file.
int msframe = 33333; // microseconds per frame
while(frameswritten+1 &lt; timestamp/msframe) {
  rgbwriter.write(rgb);
  depthwriter.write(depth);
  frameswritten++;
  printf(&quot;Frame %d filled.\n&quot;, frameswritten);
}</code></pre><p>Using the code I provide in the attached files, you should be able to split your oni files into separate depth and rgb streams, and save them in lossless avi format, while correcting for variable FPS in the recording. There is also python code for reading these files using the opencv python bindings.</p><p>I’ll add a few more posts on this topic, giving code snipplets for doing various things, like converting OpenNI depth and rgb maps to opencv Mats, expanding the 16 bit depth map into two channels of rgb video, and collapsing it back with python opencv bindings. Still, everything you need should be in the following code package:</p><p>&lt;dead link, sorry&gt; (blame bitbucket)</p><div style="margin-top:3em;padding-top:1em;border-top:1px solid #ddd;display:flex;justify-content:space-between;font-size:0.9em"><div style="flex:1"><div><div style="color:#666;margin-bottom:0.25em">← Previous</div><a href="videowriter.html">open a videowriter based on a videocapture</a></div></div><div style="flex:1;text-align:right"><div><div style="color:#666;margin-bottom:0.25em">Next →</div><a href="mat-conversion.html">converting from openni map to opencv mat.</a></div></div></div></div><div class="contentPadding_fiw0lep"></div></div><div class="footer_fg9dplh"></div></div>
  </div>
</body>
</html>