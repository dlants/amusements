<!DOCTYPE html>
<html>
<head>
  <title>lossless video recording with opencv</title>
  <style>button,hr,input{overflow:visible}audio,canvas,progress,video{display:inline-block}progress,sub,sup{vertical-align:baseline}html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0} menu,article,aside,details,footer,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:100%;line-height:1.15;margin:0}button,input{}button,select{text-transform:none}[type=submit], [type=reset],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}[hidden],template{display:none}.tableOfContents_f1uwvcyt{padding-bottom:10px;padding-top:10px}.tableOfContents_f1uwvcyt ul{list-style:none;margin:0;padding-left:0}.tableOfContents_f1uwvcyt li{padding-bottom:4px;padding-top:4px}.tableOfContents_f1uwvcyt a{color:hsl(0, 0%, 0%);text-decoration:none}.tableOfContents_f1uwvcyt a:hover{text-decoration:underline}.heading_f12eg0h7 a{color:inherit;text-decoration:none}.heading_f12eg0h7 a:hover{text-decoration:underline}.code_f1w1fzvs{background-color:hsl(0, 0%, 90%);border-radius:3px;font-family:'Roboto Mono', monospace;font-size:0.9em;padding:2px}.codeBlock_fuc7d7h{background-color:hsl(0, 0%, 90%);border-radius:4px;font-family:'Roboto Mono', monospace;font-size:0.85em;overflow-x:auto;padding:12px;white-space:pre-wrap;word-break:break-word}.blockquote_ffkcpe7{border-left:3px solid hsl(0, 0%, 60%);color:hsl(0, 0%, 60%);margin-left:0;padding-left:16px}.table_f1nyxqnd{border-collapse:collapse;margin-bottom:16px;margin-top:16px;width:100%}.tableCell_f1yllkyw{border:1px solid hsl(0, 0%, 90%);padding:8px}.image_f6w00t0{max-width:100%}.embedContainer_fa48ejj{height:0;margin-bottom:16px;margin-top:16px;padding-bottom:56.25%;position:relative;width:100%}.embedContainer_fa48ejj iframe{height:100%;left:0;position:absolute;top:0;width:100%}.captionedImage_f1x6g9qq{align-items:center;display:flex;flex-direction:column;margin-bottom:16px;margin-top:16px}.caption_fqua3ls{color:hsl(0, 0%, 60%);font-size:0.9em;font-style:italic;margin-top:8px;max-width:90%;padding-left:16px;text-align:left}.header_f15ej8wx{-ms-flex-direction:column;-ms-flex-negative:0;-webkit-flex-direction:column;-webkit-flex-shrink:0;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:column;flex-shrink:0}.topHeaderRow_fmhimpa{background:hsl(0, 0%, 90%)}.headerRow_f1jl748l{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:flex-end;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0;flex-wrap:nowrap;max-width:100%;overflow:hidden;padding-left:15px;padding-right:15px}.headerRow_f1jl748l>*{margin-right:10px !important}.headerRow_f1jl748l>*:last-child{margin-right:0px !important}.headerItem_fu8qgk4{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0}.headerItem_fu8qgk4 a{color:hsl(0, 0%, 0%);text-decoration:none;text-decoration-color:hsl(0, 0%, 90%)}.headerItem_fu8qgk4 a:hover{background-color:hsl(0, 0%, 90%)}.homeLink_f1xjhvru{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:center;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0;text-decoration:none}.homeLink_f1xjhvru>*{margin-right:10px !important}.homeLink_f1xjhvru>*:last-child{margin-right:0px !important}.homeLink_f1xjhvru img{max-height:30px}.divider_fiw0lep,.contentPadding_fiw0lep,.postTitle_fiw0lep{-ms-flex:1;-webkit-flex:1;flex:1}.rightSection_fqrlanr{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:center;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0}.rightSection_fqrlanr>*{margin-right:10px !important}.rightSection_fqrlanr>*:last-child{margin-right:0px !important}.page_fghohlb{-ms-flex-direction:column;-webkit-flex-direction:column;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-direction:column}.contentContainer_f16f73v0{-ms-flex:1;-ms-flex-direction:row;-webkit-flex:1;-webkit-flex-direction:row;display:-ms-flexbox;display:-webkit-flex;display:flex;flex:1;flex-direction:row}.content_f14hn0h0{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0}@media (min-width: 741px){.content_f14hn0h0{max-width:720px}}@media (max-width: 740px){.content_f14hn0h0{padding-left:10px;padding-right:10px;width:100%}}.footer_fg9dplh{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0;height:300px}html{font-size:16px;line-height:1.5}html a{color:hsl(0, 0%, 40%);text-decoration-color:hsl(0, 0%, 40%)}html ol,html ol ol ol ol{list-style-type:decimal}html ol ol,html ol ol ol ol ol{list-style-type:lower-alpha}html ol ol ol,html ol ol ol ol ol ol{list-style-type:lower-roman}html, body{height:100%;margin:0;padding:0;width:100%}html{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}#root{height:100%;width:100%}.postList_f1vpqs3t{-ms-flex-direction:column;-webkit-flex-direction:column;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-direction:column}.postList_f1vpqs3t>*{margin-bottom:10px !important}.postList_f1vpqs3t>*:last-child{margin-bottom:0px !important}.postRow_fay7vi3{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0}.postRow_fay7vi3>*{margin-right:10px !important}.postRow_fay7vi3>*:last-child{margin-right:0px !important}.postDate_f1hnfeg5{-ms-flex-negative:0;-webkit-flex-shrink:0;color:hsl(0, 0%, 60%);flex-basis:auto;flex-shrink:0;min-width:100px}.postTitle_fxdkkk0{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0}.tag_fmp4oti{-ms-flex-negative:0;-webkit-flex-shrink:0;background-color:hsl(0, 0%, 90%);border-radius:3px;flex-basis:auto;flex-shrink:0;font-size:0.85em;padding:2px 6px}.pageTitle_f4350h6{font-size:2em;margin-bottom:10px}.subtitle_f1smo6w8{margin-bottom:30px}.section_f1lnkzdl{-ms-flex-direction:column;-webkit-flex-direction:column;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-direction:column;margin-bottom:30px}.sectionTitle_fnb89nq{font-size:1.5em;margin-bottom:5px}.legend_fattp86{color:hsl(0, 0%, 60%);font-size:0.9em;margin-bottom:15px}.postRow_f1fes45i{-ms-flex-direction:row;-ms-flex-negative:0;-webkit-flex-direction:row;-webkit-flex-shrink:0;align-items:flex-start;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-basis:auto;flex-direction:row;flex-shrink:0}.postRow_f1fes45i>*{margin-right:10px !important}.postRow_f1fes45i>*:last-child{margin-right:0px !important}.starIndicator_fdfkslr{-ms-flex-negative:0;-webkit-flex-shrink:0;flex-basis:auto;flex-shrink:0;text-align:center;width:16px}.postDate_f6dpeik{-ms-flex-negative:0;-webkit-flex-shrink:0;color:hsl(0, 0%, 60%);flex-basis:auto;flex-shrink:0}.pageTitle_faq0mi2{font-size:1.4em;font-weight:bold;margin-bottom:20px}</style>
  <style>
    html { font-family: 'Roboto', sans-serif; }
  </style>
  <link rel="icon" href="./black-rectangle.svg">
  <meta name="viewport" content="width=device-width">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono" rel="stylesheet">
  <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
</head>
<body>
  <a rel="me" style="display: none" href="https://mastodon.dlants.me/@dlants">Mastodon</a>
  <div id="root">
    <div class="page_fghohlb"><div class="header_f15ej8wx"><div class="headerRow_f1jl748l topHeaderRow_fmhimpa"><a class="homeLink_f1xjhvru" href="index.html"><div><?xml version="1.0" encoding="utf-8"?>
<svg width="9px" height="16px" viewBox="0 0 9 16" id="emoji" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <rect x="0" y="0" width="9" height="16" fill="rgb(0, 0, 0)"/>
</svg>
</div><span>dlants.me</span></a><div class="divider_fiw0lep"></div><div class="rightSection_fqrlanr"><div class="headerItem_fu8qgk4"><a href="tech.html">tech</a></div><div class="headerItem_fu8qgk4"><a href="climbing.html">climbing</a></div><div class="headerItem_fu8qgk4"><a href="education.html">education</a></div><div class="headerItem_fu8qgk4"><a href="etc.html">etc</a></div><div class="headerItem_fu8qgk4"><a href="about.html">about me + contact</a></div><div class="headerItem_fu8qgk4"><a href="reading-recs.html">reading recs</a></div><div class="headerItem_fu8qgk4 subscribe_f45h">| <a href="rss">rss</a> <a href="atom">atom</a> <a href="buttondown.html">newsletter</a></div></div></div></div><div class="contentContainer_f16f73v0"><div class="contentPadding_fiw0lep"></div><div class="content_f14hn0h0"><h1>lossless video recording with opencv</h1><div style="color:#666;font-size:0.9em;margin-bottom:1em">August 30, 2012</div><p>In my work it is really important that I save pixel-perfect lossless video through opencv. I prefer prototyping in python, which unfortunately doesn’t have friendly openni bindings. My solution has been to convert my openni recordings to two separate video files. In order to convert the 16 bit depth stream to an 8 bit 3 channel video, I put the first 8 bits into the red channel and the second 8 bits into the green channel.</p><p>Up until a little while ago, I was using the opencv fourcc codec 0 for this. This used to default to an uncompressed video file which, despite its size, looked perfect when I reconstructed my depth image from the two channels of the video. This resulted in a .avi file with codex 0x00000000, and mediainfo told me that this was the Basic Windows bitmap format. 1, 4 and 8 bit.</p><p>Then, after an ubuntu update, I suddenly stopped being able to read those files. The new files that were recorded (with codec 0) had artifacts in reconstruction. After a bit of confusion I realized that opencv started thinking of codec 0 as a default setting and switching the format to I420. This is supposed to be a lossless codec, but I think either the conversion to YUV or the chroma subsampling that was screwing over my reconstruction.</p><p>I tried a variety of lossless codecs available through opencv, but they either gave me similar artifacts or did not work. For instance, I could never get ‘DIB ‘ to work, despite it being recommended on the opencv codec page. Insead I got the following error:</p><pre class="codeBlock_fuc7d7h"><code>OpenCV-2.4.1/modules/highgui/src/cap_gstreamer.cpp:483: error: (-210) Gstreamer Opencv backend doesn&#x27;t support this codec acutally. in function CvVideoWriter_GStreamer::open
Aborted (core dumped)</code></pre><p>After consulting with a senior student in my program, who is familiar with ffmpeg, I arrived at the following hack, which avoids using the VideoWriter object to save lossless video. The idea is to use imwrite to save each frame of the video to a .png file, and then stitch them all together via ffmpeg into an mov file. The resulting files have codec 0x20676E70, with id png – Portable Network Graphic. Strangely, opencv is capable of reading these files, even though it gives a similar gstreamer error when trying to write them.</p><p>Without further ado, here is the code I used to save each depth frame as a png. Create a folder outimg in the same folder as your video. Then,</p><pre class="codeBlock_fuc7d7h"><code>std::ostringstream out_depth;
...
expand_depth(playback.pDepthMap, expanded_depth, playback.rows, playback.cols);
out_depth &lt;&lt; root &lt;&lt; &quot;/outimg/depth&quot; &lt;&lt; framecount &lt;&lt; &quot;.png&quot;;
cv::imwrite(out_depth.str(), expanded_depth);
framecount++;
...</code></pre><p>You can find the playback object and the expand_depth function in my older post on splitting openni recordings.</p><p>Next, the magic happens with the following command:</p><pre class="codeBlock_fuc7d7h"><code>ffmpeg -i ./outimg/depth%d.png -vcodec png depth.mov</code></pre><p>I installed ffmpeg along with opencv, according to <a href="http://www.ozbotz.org/opencv-installation/">these</a> instructions.</p><p>Hopefully this gives you all enough to go on!</p><div style="margin-top:3em;padding-top:1em;border-top:1px solid #ddd;display:flex;justify-content:space-between;font-size:0.9em"><div style="flex:1"><div><div style="color:#666;margin-bottom:0.25em">← Previous</div><a href="mat-conversion.html">converting from openni map to opencv mat.</a></div></div><div style="flex:1;text-align:right"><div><div style="color:#666;margin-bottom:0.25em">Next →</div><a href="math-autobiography.html">Math Autobiography</a></div></div></div></div><div class="contentPadding_fiw0lep"></div></div><div class="footer_fg9dplh"></div></div>
  </div>
</body>
</html>